{{template "base" .}}

{{define "content"}}
  <script type="text/javascript" src="https://cdn.omise.co/omise.js"></script>

  <h3><img width="70px" src="/static/img/btc.png">Buy BTC From Me</h3>
  <form method="post" id="buy-btc-form" action="/create-order">
    <div class="row mt-3">
      <div class="form-group">
        <div class="mt-3">
          <input type="text" id="btc_addr" name="btc_addr" value="" class="form-control"  aria-describedby="btc_addr" placeholder="Enter Bitcoin Address">
        </div>
        <div id="addressHelp" class="form-text">Bitcoin Address we will send bought Bitcoin to.</div>
        <div class="mt-3">
          <input type="text" id="btc_amount" name="btc_amount" value="" class="form-control" aria-describedby="amount" placeholder="Enter Amount">
        </div>
        <div id="btcprice-hint" class="form-text">Price Per 1 BTC</div>
        <div class="mt-3">
          <input type="text" class="form-control" id="to-pay" name="to-pay" aria-describedby="to-pay" placeholder="To Pay" disabled>
        </div>
        <div id="addressHelp" class="form-text">amount to pay in USD</div>

        <div class="mt-3">

        </div>
        <input type="hidden" name="csrf_token" value="{{index .Data "csrf_token"}}"/>

      </div>
    </div>
    <div class="row mt-3">
      <div class="col">
        <input type="submit" value="Pay" id="pay-button" class="btn btn-primary"/>
      </div>
    </div>
  </form>

  <script type="text/javascript">
    var BTCPRICE = undefined;

    function omisePaymentForm(omiseAmount) {
        const { OmiseCard } = window
        
        omiseAmount = parseFloat(omiseAmount) * 100

        OmiseCard.configure({
          publicKey: {{index .Data "omise_key"}},
          amount: omiseAmount,
        })

        OmiseCard.open({
          amount: omiseAmount,
          currency: "USD",
          defaultPaymentMethod: "credit_card",
          onCreateTokenSuccess: (nonce) => {
            console.log("token created succesfully", nonce)
            $("#pay-button").attr("disabled", false);
          },
          onFormClosed: () => {
            $("#pay-button").attr("disabled", false);
          }
        })
    };
    // ---------------------------------------------------
    $("#buy-btc-form").submit(function(e) {
          $("#pay-button").attr("disabled", true);
          e.preventDefault();
      
          var form = $(this);
          const actionUrl = form.attr('action');
          const omiseAmount = $("#to-pay").val();
          console.log("to Pay:", omiseAmount)
          
          $.ajax({
              type: "POST",
              url: actionUrl,
              data: form.serialize(), // serializes the form's elements.
              success: function(data)
              {
                console.log(data.errors)
                if (data.status=='err'){
                  if (data.errors.btc_addr) {
                    console.log("validation error")
                    $("#btc_addr").attr("class","form-control is-invalid");
                  } else {
                    $("#btc_addr").attr("class","form-control");
                  }
                  
                  if (data.errors.btc_amount) {
                    console.log("validation error")
                    $("#btc_amount").attr("class","form-control is-invalid");
                  } else {
                    $("#btc_amount").attr("class","form-control");
                  }

                  $("#pay-button").attr("disabled", false);
                }else {
                  omisePaymentForm(omiseAmount)
                }
                
              }
          });
      });

  $(document).ready(function(){
    $.ajax({ url: "/get-btc-price",
        context: document.body,
        success: function(done){
          console.log(done)
          BTCPRICE = parseFloat(done.btc_price) * (1 + done.sell_margin);

          var str = "Price per 1 BTC = " + BTCPRICE;
          $('#btcprice-hint').html(str);
        }
    });
  });
  $( "#btc_amount").keyup(function() {
    const amountToBuy = $("#btc_amount").val();

    console.log(amountToBuy)
    if (amountToBuy) {
      $("#to-pay").val(BTCPRICE * parseFloat(amountToBuy));
    } else {
      $("#to-pay").val("");
    }
   
  });
  </script>
  {{end}}